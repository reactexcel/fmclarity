<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/ORM/Model.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/ORM/Model.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author 			Leo Keith &lt;leo@fmclarity.com>
 * @copyright 		2016 FM Clarity Pty Ltd.
 */

import { Mongo } from 'meteor/mongo';
import { check } from 'meteor/check';

//import { DocOwners } from 'meteor/fmc:doc-owners';
import ORM from './ORM.jsx';
import ValidationService from './ValidationService.jsx';
import ValidatedMethod from './ValidatedMethod.jsx';

/**
 * @memberOf 		module:core/ORM
 */
class Model {
	constructor( { schema, collection, mixins } ) {
		this.schema = schema;

		// either create or register the current collection
		if ( _.isString( collection ) ) {
			this.collection = new Mongo.Collection( collection );
			this._name = collection;
		} else if ( _.isObject( collection ) ) {
			this.collection = collection;
			this._name = collection._name;
		}

		ORM.collections[ this._name ] = this.collection;

		//DocOwners.register( this );
		// should be collection.addFeature( DocOwners );

		if ( collection.helpers != null ) {
			collection.helpers( {
				getSchema: function() {
					return collection._schema;
				}
			} );
		}

		this.save = new ValidatedMethod( {
			name: `${this._name}.upsert`,
			validate: ValidationService.validator( this.schema ),
			run: ( ...args ) => {
				return this._save( ...args )
			}
		} )

		if ( mixins ) {
			this.registerMixins( mixins );
		}
	}

	registerMixins( mixins ) {
		mixins.map( ( mixin ) => {
			//console.log( mixin );
			if ( _.isArray( mixin ) ) {
				let [ module, options ] = mixin;
				if ( module ) {
					module.register( this, options );
				}
			} else {
				mixin.register( this )
			}
		} );
	}

	// this function may be redundant now that we are using a different autoform architecture
	getDefaultValue( fieldName, item ) {
		let field = this.schema[ fieldName ];
		if ( _.isFunction( field.defaultValue ) ) {
			return field.defaultValue( item );
		} else if ( field.defaultValue != null ) {
			return field.defaultValue;
		} else if ( field.type == "string" ) {
			return "";
		} else if ( field.type == "number" ) {
			return 0;
		} else if ( field.type == "date" ) {
			return new Date();
		} else if ( field.schema != null ) {
			if ( _.isFunction( field.schema.create ) ) {
				return field.schema.create();
			}
			return {};
		} else if ( _.isArray( field.type ) ) {
			return [];
		} else if ( field.type == "object" ) {
			return {};
		}
	}

	create( item = {} ) {
		if ( this.schema == null ) {
			throw new Meteor.Error( "Can't create item with no schema" );
		}

		let newItem = {};
		for ( let fieldName in this.schema ) {
			newItem[ fieldName ] = this.getDefaultValue( fieldName, item )
		}
		Object.assign( newItem, item );
		return newItem;
	}


	find( ...args ) {
		return this.collection.find( ...args );
	}


	findOne( ...args ) {
		let doc = this.collection.findOne( ...args );
		return this.join( doc );
	}

	findAll( ...args ) {
		let docs = this.collection.find( ...args ).fetch();
		docs.map( ( doc ) => {
			this.join( doc );
		} );
		return docs;
	}

	_save( doc, newValues ) {
		let selector = null;
		if ( doc._id != null ) {
			selector = doc._id;
		}
		Object.assign( doc, newValues );
		doc = this.unjoin( doc );

		return this.collection.upsert( selector, { $set: _.omit( doc, '_id' ) } );
	}

	join( doc ) {
		if ( doc == null ) {
			//console.log( 'Tried to call "join" but no document provided' );
			return;
		}

		let fieldNames = Object.keys( this.schema );
		fieldNames.map( ( fieldName ) => {
			let rules = this.schema[ fieldName ];
			if ( rules.relation == null ) {
				//console.log( 'Tried to call join on a document with no "relation" property in the schema' );
			} else {
				if ( _.isFunction( rules.relation.join ) ) {
					doc[ fieldName ] = rules.relation.join( doc );
					return;
				}
			}
		} )

		return doc;
	}

	unjoin( doc ) {
		if ( doc == null ) {
			//console.log( 'Tried to call "join" but no document provided' );
			return;
		}

		let fieldNames = Object.keys( this.schema );
		fieldNames.map( ( fieldName ) => {
			let rules = this.schema[ fieldName ];
			if ( rules.relation == null ) {
				//console.log( 'Tried to call join on a document with no "relation" property in the schema' );
			} else if ( rules.relation ) {
				if ( _.isFunction( rules.relation.unjoin ) ) {
					doc[ fieldName ] = rules.relation.unjoin( doc );
					if ( doc[ fieldName ] == null ) {
						delete doc[ fieldName ];
					}
					return;
				}
			}
		} )

		return doc;
	}

	methods( functions ) {
		return RBAC.methods( functions, this )
	}
	actions( functions ) {
		return RBAC.methods( functions, this )
	}
	mixins( functions ) {
		return RBAC.mixins( functions, this );
	}
	helpers( ...args ) {
		return this.collection.helpers( ...args );
	}
}

export default Model;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-core_Actions.html">core/Actions</a></li><li><a href="module-core_Authentication.html">core/Authentication</a></li><li><a href="module-core_AutoForm.html">core/AutoForm</a></li><li><a href="module-core_Layouts.html">core/Layouts</a></li><li><a href="module-core_ORM.html">core/ORM</a></li><li><a href="module-features.html">features</a></li><li><a href="module-features_Admin.html">features/Admin</a></li><li><a href="module-features_Compliance.html">features/Compliance</a></li><li><a href="module-features_Reports.html">features/Reports</a></li><li><a href="module-mixins.html">mixins</a></li><li><a href="module-mixins_Areas.html">mixins/Areas</a></li><li><a href="module-mixins_Members.html">mixins/Members</a></li><li><a href="module-mixins_Owners.html">mixins/Owners</a></li><li><a href="module-mixins_Roles.html">mixins/Roles</a></li><li><a href="module-mixins_Services.html">mixins/Services</a></li><li><a href="module-mixins_Thumbs.html">mixins/Thumbs</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_Documents.html">models/Documents</a></li><li><a href="module-models_Facilities.html">models/Facilities</a></li><li><a href="module-models_Files.html">models/Files</a></li><li><a href="module-models_Messages.html">models/Messages</a></li><li><a href="module-models_Notifications.html">models/Notifications</a></li><li><a href="module-models_Requests.html">models/Requests</a></li><li><a href="module-models_Teams.html">models/Teams</a></li><li><a href="module-models_Users.html">models/Users</a></li><li><a href="module-ui.html">ui</a></li><li><a href="module-ui_Calendar.html">ui/Calendar</a></li><li><a href="module-ui_DataTable.html">ui/DataTable</a></li><li><a href="module-ui_MaterialInputs.html">ui/MaterialInputs</a></li><li><a href="module-ui_MaterialMisc.html">ui/MaterialMisc</a></li><li><a href="module-ui_MaterialNavigation.html">ui/MaterialNavigation</a></li><li><a href="module-ui_MaterialViews.html">ui/MaterialViews</a></li><li><a href="module-ui_Modal.html">ui/Modal</a></li><li><a href="module-ui_Stepper.html">ui/Stepper</a></li><li><a href="module-ui_Tabs.html">ui/Tabs</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_Actions.Action.html">Action</a></li><li><a href="module-core_Actions.ActionGroup.html">ActionGroup</a></li><li><a href="module-core_Actions.Route.html">Route</a></li><li><a href="module-core_Actions.RouteGroup.html">RouteGroup</a></li><li><a href="module-core_AutoForm.AutoForm.html">AutoForm</a></li><li><a href="module-core_AutoForm.FormController.html">FormController</a></li><li><a href="module-core_Layouts.BlankLayout.html">BlankLayout</a></li><li><a href="module-core_Layouts.FloatingActionButtonContainer.html">FloatingActionButtonContainer</a></li><li><a href="module-core_Layouts.MainLayout.html">MainLayout</a></li><li><a href="module-core_Layouts.NavigationDrawerContainer.html">NavigationDrawerContainer</a></li><li><a href="module-core_Layouts.PrintLayout.html">PrintLayout</a></li><li><a href="module-core_Layouts.TopNavigationBarContainer.html">TopNavigationBarContainer</a></li><li><a href="module-core_Layouts.WideLayout.html">WideLayout</a></li><li><a href="module-core_ORM.Model.html">Model</a></li><li><a href="module-core_ORM.ValidatedMethod.html">ValidatedMethod</a></li><li><a href="module-models_Facilities.FacilityPanel.html">FacilityPanel</a></li><li><a href="module-models_Users.UserPageProfileContainer.html">UserPageProfileContainer</a></li><li><a href="module-ui_MaterialInputs.DateInput.html">DateInput</a></li><li><a href="module-ui_MaterialInputs.DateTime.html">DateTime</a></li><li><a href="module-ui_MaterialInputs.FileField.html">FileField</a></li><li><a href="module-ui_MaterialInputs.PlainCard.html">PlainCard</a></li><li><a href="module-ui_MaterialInputs.Rating.html">Rating</a></li><li><a href="module-ui_MaterialInputs.Select.html">Select</a></li><li><a href="module-ui_MaterialInputs.Switch.html">Switch</a></li><li><a href="module-ui_MaterialInputs.Text.html">Text</a></li><li><a href="module-ui_MaterialInputs.TextArea.html">TextArea</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Elastic">Elastic</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Sep 21 2016 21:54:02 GMT+1000 (E. Australia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
