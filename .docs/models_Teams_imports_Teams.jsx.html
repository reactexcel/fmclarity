<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/Teams/imports/Teams.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/Teams/imports/Teams.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author 			Leo Keith &lt;leo@fmclarity.com>
 * @copyright 		2016 FM Clarity Pty Ltd.
 */
import TeamSchema from './schemas/TeamSchema.jsx';

import { Model } from '/modules/core/ORM';

// requires users
import { Owners } from '/modules/mixins/Owners';
import { Members } from '/modules/mixins/Members';

import { Thumbs } from '/modules/mixins/Thumbs';

import { DocMessages } from '/modules/models/Messages';
import { Documents, DocAttachments } from '/modules/models/Documents';
import { Facilities } from '/modules/models/Facilities';

//console.log( Members );

if ( Meteor.isServer ) {
	Meteor.publish( 'Teams', () => {
		return Teams.find();
	} )
} else {
	Meteor.subscribe( 'Teams' );
}

/**
 * @memberOf 		module:models/Teams
 */
const Teams = new Model( {
	schema: TeamSchema,
	collection: "Teams",
	mixins: [
		[ Owners ],
		[ Thumbs, { defaultThumbUrl: 0 } ],
		[ DocAttachments, { authentication: AuthHelpers.managerOrOwner } ],
		[ Members, {
			fieldName: "members",
			authentication: AuthHelpers.managerOrOwner,
		}, , {
			fieldName: "suppliers",
			authentication: AuthHelpers.managerOrOwner,
		} ],
		[ DocMessages, {
			authentication: AuthHelpers.adminManagerOrOwner,
			helpers: {
				getInboxName() {
					return this.getName();
				},
				getWatchers() {
					return this.getMembers( {
						role: {
							$in: [ "manager", "portfolio manager" ]
						}
					} );
					var members = this.getMembers( {
						role: "manager"
					} );
					var watchers = [];
					if ( members &amp;&amp; members.length ) {
						members.map( ( m ) => {
							watchers.push( {
								role: "manager",
								watcher: m
							} );
						} )
					}
					return watchers;
				}
			}
		} ]
	]
} );

Teams.methods( {

	inviteMember: {
		authentication: AuthHelpers.managerOrOwner,
		method: inviteMember,
	},

	inviteSupplier: {
		authentication: AuthHelpers.manager,
		method: inviteSupplier,
	},

	sendMemberInvite: {
		authentication: true,
		method: sendMemberInvite
	},

	setServicesRequired: {
		authentication: AuthHelpers.managerOrOwner,
		method: function( team, servicesRequired ) {
			Teams.update( team._id, {
				$set: {
					servicesRequired: servicesRequired
				}
			} );
		}
	},
	setServicesProvided: {
		authentication: AuthHelpers.managerOrOwner,
		method: function( team, services ) {
			Teams.update( team._id, {
				$set: {
					services: services
				}
			} );
		}
	},
	getAvailableServices: {
		authentication: true,
		helper: function( team, parent ) {
			var services = parent ? parent.children : team.services;
			var availableServices = [];
			if ( !services ) {
				return;
			}
			services.map( function( service ) {
				if ( service &amp;&amp; service.active ) {
					availableServices.push( service );
				}
			} );
			return availableServices;
		}
	}
} );

function getSuppliers() {
	var ids = [];
	//if we have any supplier - add their ids to our list of ids
	if ( this.suppliers &amp;&amp; this.suppliers.length ) {
		this.suppliers.map( function( s ) {
			ids.push( s._id );
		} )
	}

	//also add any suppliers of the requests allocated to us
	var requests = this.getRequests();
	if ( requests &amp;&amp; requests.length ) {
		requests.map( function( i ) {
			if ( i.team ) {
				ids.push( i.team._id );
			}
		} )
	}

	return Teams.find( {
			_id: {
				$in: ids
			}
		}, {
			sort: {
				name: 1,
				_id: 1
			}
		} )
		.fetch();
}

function inviteSupplier( team, searchName, ext ) {
	var supplier;
	searchName = searchName.trim();
	supplier = Teams.findOne( {
		name: {
			$regex: searchName,
			$options: 'i'
		}
	} );
	if ( !supplier ) {
		supplier = Meteor.call( "Teams.create", {
			type: "contractor",
			name: searchName,
			owner: {
				_id: team._id,
				name: team.name,
				type: "team"
			}
		} );
		supplier = Teams.findOne( supplier._id );
	}
	Meteor.call( "Teams.addSupplier", team, {
		_id: supplier._id
	}, ext );
	return supplier;
}

function inviteMember( team, email, ext ) {
	var user, id;
	var found = false;
	ext = ext || {};
	//user = Accounts.findUserByEmail(email);
	user = Users.findOne( {
		emails: {
			$elemMatch: {
				address: email
			}
		}
	} );
	if ( user ) {
		found = true;
	} else {
		var name = DocMessages.isValidEmail( email );
		if ( name ) {
			if ( Meteor.isServer ) {
				//Accounts.sendEnrollmentEmail(id);
				var params = {
					name: name,
					email: email
				};
				if ( ext.owner ) {
					params.owner = ext.owner;
				}
				user = Meteor.call( "Users.create", params );
			}
		} else {
			return RBAC.error( 'email-blocked', 'Blocked:', 'Sorry, that email address has been blocked.' );
		}
	}
	if ( user ) {
		Meteor.call( "Teams.addMember", team, {
			_id: user._id
		}, {
			role: ext.role
		} );
		//return user;
		return {
			user: user,
			found: found
		}
	}
}

function sendMemberInvite( team, member ) {
	team = Teams._transform( team );
	//console.log(member);
	Meteor.call( 'Messages.composeEmail', {
		recipient: member,
		subject: team.getName() + " has invited you to join FM Clarity",
		template: TeamInviteEmailTemplate,
		params: {
			team: team,
			user: member,
			token: FMCLogin.generatePasswordResetToken( member )
		}
	} )
}

Teams.helpers( {

	//this is just used for new and sticky
	//perhaps it should be in the view?
	//I don't like it in the model
	isNew() {
		return this.name == null || this.name.length == 0;
	},

	getProfile() {
		return this;
	},

	getTimeframe( priority ) {
		var timeframes = this.timeframes || {
			"Scheduled": 7 * 24 * 3600,
			"Standard": 24 * 3600,
			"Urgent": 2 * 3600,
			"Critical": 1,
		};
		var timeframe = timeframes[ priority ] ? timeframes[ priority ] : timeframes[ 'Standard' ];
		return timeframe;
	},

	getNextWOCode() {
		if ( !this.counters ) {
			this.counters = {};
		}
		if ( !this.counters.WO ) {
			this.counters.WO = 0;
		}
		this.counters.WO = this.counters.WO + 1;
		Team.save.call();
		/*
		Teams.collection.update( {
			_id: this._id
		}, {
			$inc: {
				"counters.WO": 1
			}
		} );
		*/
		//this.save();
		return this.counters.WO;
	},

	//duplicate this in the publish functions
	//for that matter can use this function directly in publich (just return cursor instead of items)
	getManagerFacilities() {
		//return all facilities in my currently selected team
		//and all the facilities in the requests user can see
		var user = Meteor.user();
		var requests, facilityIds = [];
		requests = user.getRequests();
		if ( requests &amp;&amp; requests.length ) {
			requests.map( function( i ) {
				if ( i.facility ) {
					facilityIds.push( i.facility._id );
				}
			} )
		}

		//console.log(facilityIds);

		var facilities = Facilities.find( {
				$or: [ {
					"team._id": this._id
				}, {
					_id: {
						$in: facilityIds
					}
				} ]
			}, {
				sort: {
					name: 1
				}
			} )
			.fetch();

		//console.log(facilities);
		return facilities;
	},

	getStaffFacilities() {
		//return all facilities user is a member of
		//and all the facilities in the requests user can see
		var user = Meteor.user();
		if ( !user ) {
			return []
		}

		var requests, facilityIds = [];
		requests = user.getRequests();
		if ( requests &amp;&amp; requests.length ) {
			requests.map( function( i ) {
				if ( i.facility ) {
					facilityIds.push( i.facility._id );
				}
			} )
		}

		//console.log(facilityIds);

		let facilities = Facilities.find( {
				$or: [ {
					$and: [
						{ "team._id": this._id },
						{ "members._id": user._id },
					]
				}, {
					_id: { $in: facilityIds }
				} ]
			}, { sort: { name: 1 } } )
			.fetch();

		//console.log(facilities);
		return facilities;
	},

	getFacilities( q ) {
		//this is vulnerable to error - what if the name changes
		//of course if we only have the name then we need to add the id at some point
		var role = this.getMemberRole( Meteor.user() );
		//console.log(role);
		if ( role == "fmc support" || role == "portfolio manager" ) {
			return this.getManagerFacilities( q );
		}
		return this.getStaffFacilities( q );
	},

	getRequests( q ) {
		//this is vulnerable to error - what if the name changes
		//of course if we only have the name then we need to add the id at some point
		var role = this.getMemberRole( Meteor.user() );
		if ( role == "manager" || role == "fmc support" ) {
			return this.getManagerRequests( q );
		}
		return this.getStaffRequests( q );
	},

	getManagerRequests( filterQuery ) {

		let q = null,
			user = Meteor.user();

		var requestsQuery = {
			$or: [
				//or team member or assignee and not draft
				{
					$and: [ {
						$or: [ {
							"team._id": this._id
						}, {
							"team.name": this.name
						} ]
					}, {
						$or: [ {
							'owner._id': user._id
						}, {
							status: {
								$nin: [ Requests.STATUS_DRAFT ]
							}
						} ]
					} ]
				},
				//or supplier team member and not draft or new
				{
					$and: [ {
						$or: [ {
							"supplier._id": this._id
						}, {
							"supplier.name": this.name
						} ]
					}, {
						status: {
							$nin: [ Requests.STATUS_DRAFT, Requests.STATUS_NEW ]
						}
					} ]
				}
			]
		}

		if ( filterQuery ) {
			q = {
				$and: [
					requestsQuery,
					filterQuery
				]
			};
		} else {
			q = requestsQuery;
		}

		return Requests.find( q )
			.fetch();
	},

	getStaffRequests( filterQuery ) {

		let q = null,
			user = Meteor.user();

		var requestsQuery = {
			$or: [
				//or team member or assignee and not draft
				{
					$and: [ {
						$or: [ {
							"team._id": this._id
						}, {
							"team.name": this.name
						} ]
					}, {
						'owner._id': user._id
					} ]
				},
				//or supplier team member and not draft or new
				{
					$and: [ {
						$or: [ {
							"supplier._id": this._id
						}, {
							"supplier.name": this.name
						} ]
					}, {
						$and: [ {
							'assignee._id': user._id
						}, {
							status: {
								$nin: [ Requests.STATUS_DRAFT, Requests.STATUS_NEW ]
							}
						} ]
					} ]
				}
			]
		}

		if ( filterQuery ) {
			q = {
				$and: [
					requestsQuery,
					filterQuery
				]
			};
		} else {
			q = requestsQuery;
		}

		return Requests.find( q )
			.fetch();
	}

} );


export default Teams;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-core_Actions.html">core/Actions</a></li><li><a href="module-core_Authentication.html">core/Authentication</a></li><li><a href="module-core_AutoForm.html">core/AutoForm</a></li><li><a href="module-core_Layouts.html">core/Layouts</a></li><li><a href="module-core_ORM.html">core/ORM</a></li><li><a href="module-features.html">features</a></li><li><a href="module-features_Admin.html">features/Admin</a></li><li><a href="module-features_Compliance.html">features/Compliance</a></li><li><a href="module-features_Reports.html">features/Reports</a></li><li><a href="module-mixins.html">mixins</a></li><li><a href="module-mixins_Areas.html">mixins/Areas</a></li><li><a href="module-mixins_Members.html">mixins/Members</a></li><li><a href="module-mixins_Owners.html">mixins/Owners</a></li><li><a href="module-mixins_Roles.html">mixins/Roles</a></li><li><a href="module-mixins_Services.html">mixins/Services</a></li><li><a href="module-mixins_Thumbs.html">mixins/Thumbs</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_Documents.html">models/Documents</a></li><li><a href="module-models_Facilities.html">models/Facilities</a></li><li><a href="module-models_Files.html">models/Files</a></li><li><a href="module-models_Messages.html">models/Messages</a></li><li><a href="module-models_Notifications.html">models/Notifications</a></li><li><a href="module-models_Requests.html">models/Requests</a></li><li><a href="module-models_Teams.html">models/Teams</a></li><li><a href="module-models_Users.html">models/Users</a></li><li><a href="module-ui.html">ui</a></li><li><a href="module-ui_Calendar.html">ui/Calendar</a></li><li><a href="module-ui_DataTable.html">ui/DataTable</a></li><li><a href="module-ui_MaterialInputs.html">ui/MaterialInputs</a></li><li><a href="module-ui_MaterialMisc.html">ui/MaterialMisc</a></li><li><a href="module-ui_MaterialNavigation.html">ui/MaterialNavigation</a></li><li><a href="module-ui_MaterialViews.html">ui/MaterialViews</a></li><li><a href="module-ui_Modal.html">ui/Modal</a></li><li><a href="module-ui_Stepper.html">ui/Stepper</a></li><li><a href="module-ui_Tabs.html">ui/Tabs</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_Actions.Action.html">Action</a></li><li><a href="module-core_Actions.ActionGroup.html">ActionGroup</a></li><li><a href="module-core_Actions.Route.html">Route</a></li><li><a href="module-core_Actions.RouteGroup.html">RouteGroup</a></li><li><a href="module-core_Authentication.LoginService.html">LoginService</a></li><li><a href="module-core_Authentication.Page403.html">Page403</a></li><li><a href="module-core_Authentication.PageChangePassword.html">PageChangePassword</a></li><li><a href="module-core_Authentication.PageLogin.html">PageLogin</a></li><li><a href="module-core_Authentication.PageLostPassword.html">PageLostPassword</a></li><li><a href="module-core_Authentication.PageNotFound.html">PageNotFound</a></li><li><a href="module-core_Authentication.PageRegister.html">PageRegister</a></li><li><a href="module-core_AutoForm.AutoForm.html">AutoForm</a></li><li><a href="module-core_AutoForm.FormController.html">FormController</a></li><li><a href="module-core_Layouts.FloatingActionButtonContainer.html">FloatingActionButtonContainer</a></li><li><a href="module-core_Layouts.LayoutBlank.html">LayoutBlank</a></li><li><a href="module-core_Layouts.LayoutMain.html">LayoutMain</a></li><li><a href="module-core_Layouts.LayoutPrint.html">LayoutPrint</a></li><li><a href="module-core_Layouts.LayoutWide.html">LayoutWide</a></li><li><a href="module-core_Layouts.NavigationDrawerContainer.html">NavigationDrawerContainer</a></li><li><a href="module-core_Layouts.TopNavigationBarContainer.html">TopNavigationBarContainer</a></li><li><a href="module-core_ORM.Model.html">Model</a></li><li><a href="module-core_ORM.ValidatedMethod.html">ValidatedMethod</a></li><li><a href="module-features_Admin.AdminPageIndex.html">AdminPageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndex.html">CompliancePageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndexContainer.html">CompliancePageIndexContainer</a></li><li><a href="module-features_Reports.PageDashboard.html">PageDashboard</a></li><li><a href="module-features_Reports.PageDashboardContainer.html">PageDashboardContainer</a></li><li><a href="module-mixins_Areas.AreasEditor.html">AreasEditor</a></li><li><a href="module-mixins_Owners.OwnerCard.html">OwnerCard</a></li><li><a href="module-mixins_Services.ServicesProvidedEditor.html">ServicesProvidedEditor</a></li><li><a href="module-mixins_Services.ServicesProvidedEditorRow.html">ServicesProvidedEditorRow</a></li><li><a href="module-mixins_Services.ServicesRequiredEditor.html">ServicesRequiredEditor</a></li><li><a href="module-mixins_Services.ServicesRequiredEditorRow.html">ServicesRequiredEditorRow</a></li><li><a href="module-models_Facilities.FacilityFilter.html">FacilityFilter</a></li><li><a href="module-models_Facilities.FacilityListTile.html">FacilityListTile</a></li><li><a href="module-models_Facilities.FacilityPanel.html">FacilityPanel</a></li><li><a href="module-models_Files.FileExplorer.html">FileExplorer</a></li><li><a href="module-models_Files.FilesPageIndex.html">FilesPageIndex</a></li><li><a href="module-models_Files.FileView.html">FileView</a></li><li><a href="module-models_Files.FileViewEdit.html">FileViewEdit</a></li><li><a href="module-models_Notifications.NotificationViewSummary.html">NotificationViewSummary</a></li><li><a href="module-models_Requests.RequestsPageIndex.html">RequestsPageIndex</a></li><li><a href="module-models_Teams.TeamPageSuppliers.html">TeamPageSuppliers</a></li><li><a href="module-models_Teams.TeamPageSuppliersContainer.html">TeamPageSuppliersContainer</a></li><li><a href="module-models_Teams.TeamPanel.html">TeamPanel</a></li><li><a href="module-models_Users.UserPageProfileContainer.html">UserPageProfileContainer</a></li><li><a href="module-models_Users.UsersPageIndex.html">UsersPageIndex</a></li><li><a href="module-ui_Calendar.Calendar.html">Calendar</a></li><li><a href="module-ui_Calendar.PageCalendar.html">PageCalendar</a></li><li><a href="module-ui_MaterialInputs.DateInput.html">DateInput</a></li><li><a href="module-ui_MaterialInputs.DateTime.html">DateTime</a></li><li><a href="module-ui_MaterialInputs.FileField.html">FileField</a></li><li><a href="module-ui_MaterialInputs.PlainCard.html">PlainCard</a></li><li><a href="module-ui_MaterialInputs.Rating.html">Rating</a></li><li><a href="module-ui_MaterialInputs.Select.html">Select</a></li><li><a href="module-ui_MaterialInputs.Switch.html">Switch</a></li><li><a href="module-ui_MaterialInputs.Text.html">Text</a></li><li><a href="module-ui_MaterialInputs.TextArea.html">TextArea</a></li><li><a href="module-ui_MaterialNavigation.NavListDropDown.html">NavListDropDown</a></li><li><a href="module-ui_MaterialNavigation.NavListTileMultiple.html">NavListTileMultiple</a></li><li><a href="module-ui_MaterialViews.ListTile.html">ListTile</a></li><li><a href="module-ui_MaterialViews.Thumbnail.html">Thumbnail</a></li><li><a href="UserPanel.html">UserPanel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Elastic">Elastic</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Sep 24 2016 20:44:24 GMT+1000 (E. Australia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
