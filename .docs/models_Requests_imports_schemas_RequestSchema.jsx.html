<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/Requests/imports/schemas/RequestSchema.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/Requests/imports/schemas/RequestSchema.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author 			Leo Keith &lt;leo@fmclarity.com>
 * @copyright 		2016 FM Clarity Pty Ltd.
 */

import CloseDetailsSchema from './CloseDetailsSchema.jsx';
import RequestLocationSchema from './RequestLocationSchema.jsx';
import RequestFrequencySchema from './RequestFrequencySchema.jsx';

import { Users } from '/modules/models/Users';
import { Teams } from '/modules/models/Teams';
import { DocExplorer } from '/modules/models/Documents';
import { FileExplorer } from '/modules/models/Files';
import { Facilities, FacilityListTile } from '/modules/models/Facilities';

import { ContactCard } from '/modules/mixins/Members';
import { Text, TextArea, Select, DateTime, Switch, DateInput, FileField } from '/modules/ui/MaterialInputs';

/**
 * @memberOf 		module:models/Requests
 */
const RequestSchema = {

	//$schema: 				"http://json-schema.org/draft-04/schema#",
	//title:       			"Request",
	//description: 			"A work request",

	//properties: 
	//{
	_id: {
		label: "Auto generated document id",
		description: "Document id generated by Mongo",
		type: "string",
		input: Text,
		options: {
			readonly: true
		}
	},

	name: {
		label: "Subject",
		type: "string",
		input: Text,
		description: "A brief, descriptive, title for the work request"
	},

	code: {
		label: "Code",
		description: "The unique code for this work request",
		type: "number",
		input: Text,
		//defaultValue: getJobCode,
		options: {
			readonly: true
		}
	},

	type: {
		label: "Request type",
		description: "The work request type (ie Ad-hoc, Preventative)",
		type: "string",
		defaultValue: "Ad-hoc",
		input: Select,
		options: {
			items: [
				"Ad-hoc",
				"Base Building",
				"Contract",
				"Defect",
				"Internal",
				"Preventative",
				"Template",
				"Warranty",
			]
		}
	},

	priority: {
		label: "Priority",
		description: "The urgency of the requested work",
		type: "string",
		defaultValue: "Standard",
		condition: ( item ) => {
			return item.type != "Preventative"
		},
		input: Select,
		size: 6,
		options: {
			items: [
				"Standard",
				"Scheduled",
				"Urgent",
				"Critical"
			]
		}
	},

	frequency: {
		/*label: "Frequency",
		description: "The frequency with which this job should occur",*/
		condition: "Preventative",
		subschema: RequestFrequencySchema,
		optional: true,
	},

	status: {

		label: "Status",
		description: "The current status of the job",
		type: "string",
		input: Select,
		readonly: true,
		defaultValue: "Draft",

		options: {
			items: [
				'Draft',
				'New',
				'Approved',
				'Accepted',
				'Quoting',
				'Complete',
				'Closed'
			]
		}
	},

	//////////////////////////////////////////////////
	// Facility dependant properties
	//////////////////////////////////////////////////
	level: {
		label: "Area",
		size: 4,
		type: "object",
		input: Select,
		options: ( item ) => {
			return {
				items: item.facility ? item.facility.areas : null
			}
		}
	},

	area: {
		label: "Sub-area",
		size: 4,
		type: "object",
		input: Select,
		optional: true,
		options: ( item ) => {
			return {
				items: item.level ? item.level.children : null
			}
		}
	},

	identifier: {
		label: "Identifier",
		description: "Area identifier for the job location (ie classroom number)",
		size: 4,
		type: "object",
		input: Select,
		optional: true,
		options: ( item ) => {
			return {
				items: item.area ? item.area.children : null
			}
		}
	},

	//////////////////////////////////////////////////

	service: {
		label: "Service",
		description: "The category of work required",
		size: 6,
		type: "object",
		input: Select,
		options: ( item ) => {
			return {
				items: item.facility ? item.facility.servicesRequired : null
			}
		}
	},

	subservice: {
		label: "Subservice",
		description: "The subcategory of work required",
		size: 6,
		type: "object",
		input: Select,
		optional: true,
		options: ( item ) => {
			return {
				items: item.service ? item.service.children : null
			}
		}
	},

	//////////////////////////////////////////////////
	// Comments
	//////////////////////////////////////////////////
	description: {
		label: "Comments",
		description: "A detailed description of the work to be completed",
		type: "string",
		input: TextArea,
		optional: true
	},

	acceptComment: {
		label: "Comment",
		description: "Comment about the acceptance of this work request",
		type: "string",
		input: TextArea,
	},

	rejectComment: {
		label: "Reason for rejection",
		description: "The reason why this job was rejected",
		type: "string",
		input: TextArea,
	},

	closeComment: {
		label: "Close comment",
		description: "Closing comments about this job",
		type: "string",
		input: TextArea
	},

	//////////////////////////////////////////////////
	// Quote related
	//////////////////////////////////////////////////
	quoteRequired: {
		label: "Quote required",
		description: "Is a quote required for this job?",
		type: "boolean",
		input: Switch
	},

	quoteIsPreApproved: {
		label: "Auto approve quote?",
		info: "An auto approved quote will ",
		type: "boolean",
		input: Switch
	},

	quote: {
		label: "Quote",
		description: "File detailing the estimated cost of this job",
		input: FileField,
	},

	quoteValue: {
		label: "Value of quote",
		description: "The cost of the requested work",
		type: "number"
	},

	//////////////////////////////////////////////////
	// Settings
	//////////////////////////////////////////////////  		
	confirmRequired: {
		label: "Completion confirmation required",
		description: "Is manager confirmation required before the job can be closed?",
		input: Switch
	},

	costThreshold: {
		label: "Value",
		type: "number",
		size: 6,
		defaultValue: 500,
		input: Text,
		condition: [ "Ad-hoc", "Contract" ],
	},

	closeDetails: {
		type: "object",
		subschema: CloseDetailsSchema
	},

	//////////////////////////////////////////////////
	// Dates &amp; timing
	//////////////////////////////////////////////////  		
	dueDate: {
		type: "date",
		label: "Due Date",
		description: "Latest date that the work can be completed",
		input: DateTime,
		size: 6,
		defaultValue: getDefaultDueDate
	},

	issuedAt: {
		type: "date",
		label: "Issued date",
		description: "Date and time that the job was issued",
		input: DateTime,
		size: 6,
	},

	eta: {
		label: "ETA",
		description: "Time the supplier is expected to attend the site",
		size: 6,
		input: DateTime,
	},

	//////////////////////////////////////////////////
	// Relations
	// Should be defined here in the schema and implemented automatically
	//////////////////////////////////////////////////

	team: {
		label: "Owning team",
		description: "The team who created this work request",
		relation: {
			join: ( item ) => {
				return Teams.findOne( item.team._id )
			},
			unjoin: ( item ) => {
				return _.pick( item.team, [ '_id', 'name' ] )
			}
		},
		input: Select,
		defaultValue: ( item ) => {
			return Session.getSelectedTeam();
		}
	},

	facility: {
		label: "Facility",
		description: "The site for this job",
		type: "object",
		relation: {
			join: ( item ) => {
				if( item.facility &amp;&amp; item.facility._id ) {
					return Facilities.findOne( item.facility._id );
				}
			},
			unjoin: ( item ) => {
				if( item.facility &amp;&amp; item.facility._id ) {
					return _.pick( item.facility, '_id', 'name' );
				}
			}
		},
		input: Select,

		options: ( item ) => {
			//console.log( item );
			return {
				items: ( item.team ? item.team.facilities : null ),
				view: ( Meteor.isClient ? FacilityListTile : null ),

				afterChange: ( item ) => {
					if ( item == null ) {
						return;
					}
					item.level = null;
					item.area = null;
					item.identifier = null;
					item.service = null;
					item.subservice = null;
					item.supplier = null;
				}
			}
		},
	},

	supplier: {
		label: "Supplier",
		description: "The supplier who has been assigned to this job",
		type: "object",
		relation: {
			type: ORM.HasOne,
			source: Teams
		},
		input: Select,
		options: ( item ) => {
			return {
				items: ( item.facility ? item.facility.suppliers : null ),
				view: ( Meteor.isClient ? ContactCard : null )
			}
		},
	},

	assignee: {
		label: "Assignee",
		description: "The individual who has been allocated to this job",
		relation: {
			type: ORM.HasOne,
			source: Users
		},
		input: Select,
		options: ( item ) => {
			return {
				items: ( item.supplier ? item.supplier.members : null ),
				view: ( Meteor.isClient ? ContactCard : null )
			}
		},
	},

	members: {
		label: "Contacts",
		description: "Stakeholders for this work request",
		defaultValue: getMembersDefaultValue
	}

	//////////////////////////////////////////////////  		
	//}
}

/*
 *
 *
 *
 */
function getMembersDefaultValue( item ) {
	console.log( item );

	if ( item.team == null ) {
		return;
	}

	let owner = Meteor.user(),
		team = Teams.findOne( item.team._id ),
		teamMembers = team.getMembers( {
			role: "portfolio manager"
		} );

	let members = [ {
		_id: owner._id,
		name: owner.profile.name,
		role: "owner"
	} ];

	teamMembers.map( ( m ) => {
		members.push( {
			_id: m._id,
			name: m.profile.name,
			role: "team manager"
		} )
	} );

	if ( item.facility ) {
		let facility = Facilities.findOne( item.facility._id ),
			facilityMembers = facility.getMembers( {
				role: "manager"
			} );

		facilityMembers.map( ( m ) => {
			members.push( {
				_id: m._id,
				name: m.profile.name,
				role: "facility manager"
			} )
		} );
	}

	return members;
}

function getTimeframe() {
	let team = this.getTeam();
	if ( team ) {
		return team.getTimeframe( this.priority );
	}
}

function getJobCode( item ) {
	let team = null,
		code = 0;

	if ( item &amp;&amp; item.team ) {
		team = Teams.findOne( {
			_id: item.team._id
		} );
		code = team.getNextWOCode();
	}

	return code;
}

function getDefaultDueDate( item ) {
	if ( !item.team ) {
		return new Date();
	}
	let team = Teams.findOne( item.team._id ),
		timeframe = team.timeframes[ 'Standard' ] * 1000,
		now = new Date();

	return new Date( now.getTime() + timeframe );
}

export default RequestSchema;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-core_Actions.html">core/Actions</a></li><li><a href="module-core_Authentication.html">core/Authentication</a></li><li><a href="module-core_AutoForm.html">core/AutoForm</a></li><li><a href="module-core_Layouts.html">core/Layouts</a></li><li><a href="module-core_ORM.html">core/ORM</a></li><li><a href="module-features.html">features</a></li><li><a href="module-features_Admin.html">features/Admin</a></li><li><a href="module-features_Compliance.html">features/Compliance</a></li><li><a href="module-features_Reports.html">features/Reports</a></li><li><a href="module-mixins.html">mixins</a></li><li><a href="module-mixins_Areas.html">mixins/Areas</a></li><li><a href="module-mixins_Members.html">mixins/Members</a></li><li><a href="module-mixins_Owners.html">mixins/Owners</a></li><li><a href="module-mixins_Roles.html">mixins/Roles</a></li><li><a href="module-mixins_Services.html">mixins/Services</a></li><li><a href="module-mixins_Thumbs.html">mixins/Thumbs</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_Documents.html">models/Documents</a></li><li><a href="module-models_Facilities.html">models/Facilities</a></li><li><a href="module-models_Files.html">models/Files</a></li><li><a href="module-models_Messages.html">models/Messages</a></li><li><a href="module-models_Notifications.html">models/Notifications</a></li><li><a href="module-models_Requests.html">models/Requests</a></li><li><a href="module-models_Teams.html">models/Teams</a></li><li><a href="module-models_Users.html">models/Users</a></li><li><a href="module-ui.html">ui</a></li><li><a href="module-ui_Calendar.html">ui/Calendar</a></li><li><a href="module-ui_DataTable.html">ui/DataTable</a></li><li><a href="module-ui_MaterialInputs.html">ui/MaterialInputs</a></li><li><a href="module-ui_MaterialMisc.html">ui/MaterialMisc</a></li><li><a href="module-ui_MaterialNavigation.html">ui/MaterialNavigation</a></li><li><a href="module-ui_MaterialViews.html">ui/MaterialViews</a></li><li><a href="module-ui_Modal.html">ui/Modal</a></li><li><a href="module-ui_Stepper.html">ui/Stepper</a></li><li><a href="module-ui_Tabs.html">ui/Tabs</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_Actions.Action.html">Action</a></li><li><a href="module-core_Actions.ActionGroup.html">ActionGroup</a></li><li><a href="module-core_Actions.Route.html">Route</a></li><li><a href="module-core_Actions.RouteGroup.html">RouteGroup</a></li><li><a href="module-core_Authentication.LoginService.html">LoginService</a></li><li><a href="module-core_Authentication.Page403.html">Page403</a></li><li><a href="module-core_Authentication.PageChangePassword.html">PageChangePassword</a></li><li><a href="module-core_Authentication.PageLogin.html">PageLogin</a></li><li><a href="module-core_Authentication.PageLostPassword.html">PageLostPassword</a></li><li><a href="module-core_Authentication.PageNotFound.html">PageNotFound</a></li><li><a href="module-core_Authentication.PageRegister.html">PageRegister</a></li><li><a href="module-core_AutoForm.AutoForm.html">AutoForm</a></li><li><a href="module-core_AutoForm.FormController.html">FormController</a></li><li><a href="module-core_Layouts.FloatingActionButtonContainer.html">FloatingActionButtonContainer</a></li><li><a href="module-core_Layouts.LayoutBlank.html">LayoutBlank</a></li><li><a href="module-core_Layouts.LayoutMain.html">LayoutMain</a></li><li><a href="module-core_Layouts.LayoutPrint.html">LayoutPrint</a></li><li><a href="module-core_Layouts.LayoutWide.html">LayoutWide</a></li><li><a href="module-core_Layouts.NavigationDrawerContainer.html">NavigationDrawerContainer</a></li><li><a href="module-core_Layouts.TopNavigationBarContainer.html">TopNavigationBarContainer</a></li><li><a href="module-core_ORM.Model.html">Model</a></li><li><a href="module-core_ORM.ValidatedMethod.html">ValidatedMethod</a></li><li><a href="module-features_Admin.AdminPageIndex.html">AdminPageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndex.html">CompliancePageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndexContainer.html">CompliancePageIndexContainer</a></li><li><a href="module-features_Reports.PageDashboard.html">PageDashboard</a></li><li><a href="module-features_Reports.PageDashboardContainer.html">PageDashboardContainer</a></li><li><a href="module-mixins_Areas.AreasEditor.html">AreasEditor</a></li><li><a href="module-mixins_Services.ServicesProvidedEditor.html">ServicesProvidedEditor</a></li><li><a href="module-mixins_Services.ServicesProvidedEditorRow.html">ServicesProvidedEditorRow</a></li><li><a href="module-mixins_Services.ServicesRequiredEditor.html">ServicesRequiredEditor</a></li><li><a href="module-mixins_Services.ServicesRequiredEditorRow.html">ServicesRequiredEditorRow</a></li><li><a href="module-models_Facilities.FacilityFilter.html">FacilityFilter</a></li><li><a href="module-models_Facilities.FacilityListTile.html">FacilityListTile</a></li><li><a href="module-models_Facilities.FacilityPanel.html">FacilityPanel</a></li><li><a href="module-models_Files.FileExplorer.html">FileExplorer</a></li><li><a href="module-models_Files.FilesPageIndex.html">FilesPageIndex</a></li><li><a href="module-models_Files.FileView.html">FileView</a></li><li><a href="module-models_Files.FileViewEdit.html">FileViewEdit</a></li><li><a href="module-models_Requests.RequestsPageIndex.html">RequestsPageIndex</a></li><li><a href="module-models_Teams.TeamPageSuppliers.html">TeamPageSuppliers</a></li><li><a href="module-models_Teams.TeamPageSuppliersContainer.html">TeamPageSuppliersContainer</a></li><li><a href="module-models_Teams.TeamPanel.html">TeamPanel</a></li><li><a href="module-models_Users.UserPageProfileContainer.html">UserPageProfileContainer</a></li><li><a href="module-models_Users.UsersPageIndex.html">UsersPageIndex</a></li><li><a href="module-ui_Calendar.CalendarPage.html">CalendarPage</a></li><li><a href="module-ui_MaterialInputs.DateInput.html">DateInput</a></li><li><a href="module-ui_MaterialInputs.DateTime.html">DateTime</a></li><li><a href="module-ui_MaterialInputs.FileField.html">FileField</a></li><li><a href="module-ui_MaterialInputs.PlainCard.html">PlainCard</a></li><li><a href="module-ui_MaterialInputs.Rating.html">Rating</a></li><li><a href="module-ui_MaterialInputs.Select.html">Select</a></li><li><a href="module-ui_MaterialInputs.Switch.html">Switch</a></li><li><a href="module-ui_MaterialInputs.Text.html">Text</a></li><li><a href="module-ui_MaterialInputs.TextArea.html">TextArea</a></li><li><a href="module-ui_MaterialNavigation.NavListDropDown.html">NavListDropDown</a></li><li><a href="module-ui_MaterialNavigation.NavListTileMultiple.html">NavListTileMultiple</a></li><li><a href="module-ui_MaterialViews.ListTile.html">ListTile</a></li><li><a href="module-ui_MaterialViews.Thumbnail.html">Thumbnail</a></li><li><a href="UserPanel.html">UserPanel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Elastic">Elastic</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Sep 22 2016 23:17:32 GMT+1000 (E. Australia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
