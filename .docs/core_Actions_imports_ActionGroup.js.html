<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/Actions/imports/ActionGroup.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/Actions/imports/ActionGroup.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author 			Leo Keith &lt;leo@fmclarity.com>
 * @copyright 		2016 FM Clarity Pty Ltd.
 */

import { Roles } from '/modules/mixins/Roles';
import { Notifications } from '/modules/models/Notifications';

/**
 * An ActionGroup holds a collection of actions. 
 * It is the primary structure used for passing around Action Groups and performing role based access control.
 * @memberOf		module:core/Actions
 * @requires 		module:mixins/Roles.Roles
 * @requires 		Notifications
 */
class ActionGroup {
	/**
	 * Create an ActionGroup.
	 * @param {object} actions - If actions are provided to the constructor the group is initialized with them
	 */
	constructor( actions ) {
		this.actions = {};
		this.accessRules = {};
		if ( actions ) {
			this.add( actions );
		}
	}

	/**
	 * Add an action to the ActionGroup.
	 * @param {Action} action - An action to be added to this group.
	 */
	addOne( action ) {
		if ( action.name == null ) {
			throw new Meteor.Error( `Tried to create a new action without a name: ${JSON.stringify(action)}` );
		}
		this.actions[ action.name ] = action;
	}

	/**
	 * @class Action.ActionGroup
	 * @method Action.ActionGroup#add
	 * @param {array} actions - A list of actions to be sequentially added to the group
	 */
	add( actions ) {
		if ( !_.isArray( actions ) ) {
			actions = [ actions ];
		}

		actions.map( ( action ) => {
			this.addOne( action );
		} )
	}

	/**
	 * Adds a single access rule to the group.
	 *
	 * Access rules can be added for each action. 
	 * If access rules are added to the global action container "Actions" they will be evaluated before the pertaining action is run in any context.
	 * If they are added to another group they will be evaluated before the action is run using that group.
	 * An optional "condition" can be added which will filter available actions by comaparing the properties of the condition object to the access item passed to the action.
	 * 
	 * The following creates an access rule for the action "complete request" that would apply to request items with the status "In Progress".
	 * The rule states that request members with the status 'supplier manager' or 'assignee' can perform the action.
	 * And that they should receive alerts when the action if performed by others.
	 *
	 * @example
	 * 	Actions.addAccessRule( {
	 *		condition: 	{ status: 'In Progress' },
	 * 		action: 	[ 'complete request' ],
	 * 		role: 		[ 'supplier manager', 'assignee' ],
	 * 		rule: 		{ alert: true }
	 *  });
	 *
	 * @param {Action} action - The action this new rule will pertain to.
	 * @param {array} roles - The roles that this rule is for.
	 * @param {object} condition - a "condition" object that will be matched against the access item to check that certain properties pertain
	 * @param {object} rile - The access rule we will add for this action
	 */
	addOneAccessRule( action, roles, condition, rule ) {
		if ( this.accessRules[ action ] == null ) {
			this.accessRules[ action ] = {};
		}
		if ( !_.isArray( roles ) ) {
			roles = [ roles ];
		}
		roles.map( ( role ) => {
			this.accessRules[ action ][ role ] = { rule, condition };
		} )
	}

	/*
	 * Adds an array of access rules to the group.
	 *
	 * @class Action.ActionGroup
	 * @method Action.ActionGroup#addAccessRule
	 * @param {Action} action - The action this new rule will pertain to.
	 * @param {array} roles - The roles that this rule is for.
	 * @param {object} condition - a "condition" object that will be matched against the access item to check that certain properties pertain
	 * @param {object} rile - The access rule we will add for this action
	 */
	addAccessRule( { action, role, condition, rule = {} } ) {
		if ( !_.isArray( action ) ) {
			action = [ action ];
		}
		if ( !rule.allowed ) {
			rule.allowed = true;
		}
		action.map( ( a ) => {
			this.addOneAccessRule( a, role, condition, rule );
		} )
	}

	/**
	 * Return a list of actions that are valid for the current user with the provided set of arguments.
	 * Used by WorkflowButtons
	 *
	 * @method Action.ActionGroup#filter
	 * @param {object} actions - A dictionary of actions that will be checked for availability.
	 * @param {...any} args - Arguments that will be used to check authentication for each action in this group.
	 * @return {array} An array of actions that are valid for this user with the provided args.
	 */
	filter( actions, ...args ) {
		let validActions = {},
			item = args[ 0 ],
			relationships = Roles.getRoles( item );

		// this is phrased in a slightly awkward way because we don't know that the keys
		//  of the passed in will actually match the name property of the action itself
		for ( i in actions ) {
			let action = actions[ i ],
				actionAvailable = true,
				actionName = action.name,
				rules = this.accessRules[ actionName ];

			if ( rules == null ) {
				console.log( `Tried to perform action '${actionName}' but access rules have not been defined` );
				continue;
			}

			if ( actionAvailable ) {
				access = this.checkAccess( actionName, item, rules, relationships );
				if ( access.allowed ) {
					validActions[ actionName ] = action;
				}
			}
		}

		return validActions;
	}

	/**
	 * Runs the specified action performing checks to verify access and calculate notification requirements.
	 * The run function of the global ActionGroup store actions is called by individual actions for their rbac.
	 *
	 * @method Action.ActionGroup#run
	 * @param {string} actionName - the name of the action to run, if an Action object is passed the name is taken from that object
	 * @param {...any} args - Arguments that will be used to check authentication for each action in this group
	 */
	run( actionName, ...args ) {

		if ( _.isObject( actionName ) ) {
			actionName = actionName.name;
		}

		let item = args[ 0 ],
			action = this.actions[ actionName ];

		if ( action == null ) {
			console.log( `Tried to run action ${actionName} but it doesn't exist` );
		}

		// getting the rules and relationships is an expensive operation so we only want to do it
		//  once before running an action...
		let { rules, relationships } = this.getRulesAndRelationships( actionName, item );

		if ( rules == null ) {
			console.log( `Tried to perform action '${actionName}' but access rules have not been defined` );
		}

		// ...that is why we precalculate rules and relationships then pass them here
		let alerts = this.checkAlerts( actionName, item, rules, relationships ),
			access = this.checkAccess( actionName, item, rules, relationships );


		if ( access.allowed ) {
			action.action( ...args );
			if ( this.path ) {
				history.pushState( {}, '', this.path );
			}

			Notifications.save.call( {
				actor: Meteor.user(),
				action: action,
				object: args
			} );
		} else {
			throw new Meteor.Error( `Access denied for action '${actionName}' ` );
		}

	}

	getRulesAndRelationships( actionName, item ) {

		if ( !item ) {
			item = Session.getSelectedTeam();
		}

		let rules = this.accessRules[ actionName ],
			relationships = Roles.getRoles( item );

		return { rules, relationships };
	}

	getType( actionName ) {
		return this.actions[ actionName ].type;
	}


	checkAccess( actionName, item, rules, relationships ) {

		if ( !item ) {
			item = Session.getSelectedTeam();
		}

		let user = Meteor.user(),
			access = {
				allowed: false,
				alert: false,
				email: false
			};

		if ( !rules &amp;&amp; !relationships ) {
			var { rules, relationships } = this.getRulesAndRelationships( actionName, item, user );
		}

		if ( relationships ) {
			userRoles = relationships.actors[ user._id ];
			//console.log( userRoles );
			if ( rules &amp;&amp; userRoles ) {
				// if any one of my relationships permits this action then I can do it
				userRoles.map( ( role ) => {
					if ( rules[ role ] ) {
						let condition = rules[ role ].condition;
						//console.log( condition );
						if ( !condition || _.findWhere( [ item ], condition ) ) {
							access.allowed = access.allowed || rules[ role ].rule.allowed;
							access.alert = access.alert || rules[ role ].rule.alert;
							access.email = access.email || rules[ role ].rule.email;
						}
					}
				} )
			} else {
				//console.log( `Action '${actionName}' has no members` );
			}
		}
		return access;
	}

	checkAlerts( actionName, item, rules, relationships ) {

		if ( !rules &amp;&amp; !relationships ) {
			var { rules, relationships } = this.getRulesAndRelationships( actionName, item );
		}

		let roleGroups = null,
			recipients = {
				alert: [],
				email: []
			};

		if ( rules &amp;&amp; relationships ) {
			roleGroups = Object.keys( relationships.roles );
			roleGroups.map( ( role ) => {
				if ( rules[ role ] /* &amp;&amp; rules[role].condition( item )*/ ) {
					if ( rules[ role ].rule.alert ) {
						recipients.alert = recipients.alert.concat( relationships.roles[ role ] );
					}
					if ( rules[ role ].rule.email ) {
						recipients.email = recipients.email.concat( relationships.roles[ role ] );
					}
				}
			} )
		}
		return recipients;
	}
}

export default ActionGroup;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-core_Actions.html">core/Actions</a></li><li><a href="module-core_Authentication.html">core/Authentication</a></li><li><a href="module-core_AutoForm.html">core/AutoForm</a></li><li><a href="module-core_Layouts.html">core/Layouts</a></li><li><a href="module-core_ORM.html">core/ORM</a></li><li><a href="module-features.html">features</a></li><li><a href="module-features_Admin.html">features/Admin</a></li><li><a href="module-features_Compliance.html">features/Compliance</a></li><li><a href="module-features_Reports.html">features/Reports</a></li><li><a href="module-mixins.html">mixins</a></li><li><a href="module-mixins_Areas.html">mixins/Areas</a></li><li><a href="module-mixins_Members.html">mixins/Members</a></li><li><a href="module-mixins_Owners.html">mixins/Owners</a></li><li><a href="module-mixins_Roles.html">mixins/Roles</a></li><li><a href="module-mixins_Services.html">mixins/Services</a></li><li><a href="module-mixins_Thumbs.html">mixins/Thumbs</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_Documents.html">models/Documents</a></li><li><a href="module-models_Facilities.html">models/Facilities</a></li><li><a href="module-models_Files.html">models/Files</a></li><li><a href="module-models_Messages.html">models/Messages</a></li><li><a href="module-models_Notifications.html">models/Notifications</a></li><li><a href="module-models_Requests.html">models/Requests</a></li><li><a href="module-models_Teams.html">models/Teams</a></li><li><a href="module-models_Users.html">models/Users</a></li><li><a href="module-ui.html">ui</a></li><li><a href="module-ui_Calendar.html">ui/Calendar</a></li><li><a href="module-ui_DataTable.html">ui/DataTable</a></li><li><a href="module-ui_MaterialInputs.html">ui/MaterialInputs</a></li><li><a href="module-ui_MaterialMisc.html">ui/MaterialMisc</a></li><li><a href="module-ui_MaterialNavigation.html">ui/MaterialNavigation</a></li><li><a href="module-ui_MaterialViews.html">ui/MaterialViews</a></li><li><a href="module-ui_Modal.html">ui/Modal</a></li><li><a href="module-ui_Stepper.html">ui/Stepper</a></li><li><a href="module-ui_Tabs.html">ui/Tabs</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_Actions.Action.html">Action</a></li><li><a href="module-core_Actions.ActionGroup.html">ActionGroup</a></li><li><a href="module-core_Actions.Route.html">Route</a></li><li><a href="module-core_Actions.RouteGroup.html">RouteGroup</a></li><li><a href="module-core_Authentication.LoginService.html">LoginService</a></li><li><a href="module-core_Authentication.Page403.html">Page403</a></li><li><a href="module-core_Authentication.PageChangePassword.html">PageChangePassword</a></li><li><a href="module-core_Authentication.PageLogin.html">PageLogin</a></li><li><a href="module-core_Authentication.PageLostPassword.html">PageLostPassword</a></li><li><a href="module-core_Authentication.PageNotFound.html">PageNotFound</a></li><li><a href="module-core_Authentication.PageRegister.html">PageRegister</a></li><li><a href="module-core_AutoForm.AutoForm.html">AutoForm</a></li><li><a href="module-core_AutoForm.FormController.html">FormController</a></li><li><a href="module-core_Layouts.FloatingActionButtonContainer.html">FloatingActionButtonContainer</a></li><li><a href="module-core_Layouts.LayoutBlank.html">LayoutBlank</a></li><li><a href="module-core_Layouts.LayoutMain.html">LayoutMain</a></li><li><a href="module-core_Layouts.LayoutPrint.html">LayoutPrint</a></li><li><a href="module-core_Layouts.LayoutWide.html">LayoutWide</a></li><li><a href="module-core_Layouts.NavigationDrawerContainer.html">NavigationDrawerContainer</a></li><li><a href="module-core_Layouts.TopNavigationBarContainer.html">TopNavigationBarContainer</a></li><li><a href="module-core_ORM.Model.html">Model</a></li><li><a href="module-core_ORM.ValidatedMethod.html">ValidatedMethod</a></li><li><a href="module-features_Admin.AdminPageIndex.html">AdminPageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndex.html">CompliancePageIndex</a></li><li><a href="module-features_Compliance.CompliancePageIndexContainer.html">CompliancePageIndexContainer</a></li><li><a href="module-features_Reports.PageDashboard.html">PageDashboard</a></li><li><a href="module-features_Reports.PageDashboardContainer.html">PageDashboardContainer</a></li><li><a href="module-mixins_Areas.AreasEditor.html">AreasEditor</a></li><li><a href="module-mixins_Owners.OwnerCard.html">OwnerCard</a></li><li><a href="module-mixins_Services.ServicesProvidedEditor.html">ServicesProvidedEditor</a></li><li><a href="module-mixins_Services.ServicesProvidedEditorRow.html">ServicesProvidedEditorRow</a></li><li><a href="module-mixins_Services.ServicesRequiredEditor.html">ServicesRequiredEditor</a></li><li><a href="module-mixins_Services.ServicesRequiredEditorRow.html">ServicesRequiredEditorRow</a></li><li><a href="module-models_Facilities.FacilityFilter.html">FacilityFilter</a></li><li><a href="module-models_Facilities.FacilityListTile.html">FacilityListTile</a></li><li><a href="module-models_Facilities.FacilityPanel.html">FacilityPanel</a></li><li><a href="module-models_Files.FileExplorer.html">FileExplorer</a></li><li><a href="module-models_Files.FilesPageIndex.html">FilesPageIndex</a></li><li><a href="module-models_Files.FileView.html">FileView</a></li><li><a href="module-models_Files.FileViewEdit.html">FileViewEdit</a></li><li><a href="module-models_Notifications.NotificationViewSummary.html">NotificationViewSummary</a></li><li><a href="module-models_Requests.RequestsPageIndex.html">RequestsPageIndex</a></li><li><a href="module-models_Teams.TeamPageSuppliers.html">TeamPageSuppliers</a></li><li><a href="module-models_Teams.TeamPageSuppliersContainer.html">TeamPageSuppliersContainer</a></li><li><a href="module-models_Teams.TeamPanel.html">TeamPanel</a></li><li><a href="module-models_Users.UserPageProfileContainer.html">UserPageProfileContainer</a></li><li><a href="module-models_Users.UsersPageIndex.html">UsersPageIndex</a></li><li><a href="module-ui_Calendar.Calendar.html">Calendar</a></li><li><a href="module-ui_Calendar.PageCalendar.html">PageCalendar</a></li><li><a href="module-ui_MaterialInputs.DateInput.html">DateInput</a></li><li><a href="module-ui_MaterialInputs.DateTime.html">DateTime</a></li><li><a href="module-ui_MaterialInputs.FileField.html">FileField</a></li><li><a href="module-ui_MaterialInputs.PlainCard.html">PlainCard</a></li><li><a href="module-ui_MaterialInputs.Rating.html">Rating</a></li><li><a href="module-ui_MaterialInputs.Select.html">Select</a></li><li><a href="module-ui_MaterialInputs.Switch.html">Switch</a></li><li><a href="module-ui_MaterialInputs.Text.html">Text</a></li><li><a href="module-ui_MaterialInputs.TextArea.html">TextArea</a></li><li><a href="module-ui_MaterialNavigation.NavListDropDown.html">NavListDropDown</a></li><li><a href="module-ui_MaterialNavigation.NavListTileMultiple.html">NavListTileMultiple</a></li><li><a href="module-ui_MaterialViews.ListTile.html">ListTile</a></li><li><a href="module-ui_MaterialViews.Thumbnail.html">Thumbnail</a></li><li><a href="UserPanel.html">UserPanel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Elastic">Elastic</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Sep 24 2016 20:44:24 GMT+1000 (E. Australia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
