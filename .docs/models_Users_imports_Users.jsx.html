<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: models/Users/imports/Users.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: models/Users/imports/Users.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author          Leo Keith &lt;leo@fmclarity.com>
 * @copyright       2016 FM Clarity Pty Ltd.
 */

import UserSchema from './schemas/UserSchema.jsx';

import { Model } from '/modules/core/ORM';

import { Documents } from '/modules/models/Documents';
import { Files } from '/modules/models/File';

//let Teams, Facilities;

import { ThumbsMixin } from '/modules/mixins/Thumbs';
import { Owners } from '/modules/mixins/Owners';
import { DocMessages } from '/modules/models/Messages';

/**
 * @memberOf        module:models/Users
 */
const Users = new Model( {
    schema: UserSchema,
    collection: Meteor.users,
    mixins: [
        Owners,
        DocMessages, [ ThumbsMixin, { repo: Files, defaultThumb: "/img/ProfilePlaceholderSuit.png" } ]
    ]
} )

if ( Meteor.isServer ) {
    Meteor.publish( 'Users', () => {
        return Users.find();
    } );
}

Users.actions( {
    getTeam: {
        authentication: true,
        helper: function() {
            var team = Session.getSelectedTeam();
            //console.log(team);
            return team;
            return Session.getSelectedTeam();
        }
    },
    getTeams: {
        authentication: true,
        helper: function( user ) {
            //import { Teams } from '/modules/models/Teams';
            return Teams.find( {
                    $or: [ {
                        "members._id": user._id
                    }, {
                        "owner._id": user._id
                    } ]
                } )
                .fetch()
        }
    },
    getRole: {
        authentication: true,
        helper: function( user, group ) {
            group = group || user.getSelectedTeam();
            if ( !group || !group.members || !group.members.length ) {
                return null;
            }
            for ( var i in group.members ) {
                var currentMember = group.members[ i ];
                if ( currentMember &amp;&amp; user &amp;&amp; currentMember._id == user._id ) {
                    return currentMember.role;
                }
            }
        },
    },
    //this to by updated to save/retrieve from database
    //thereby making persistent
    getSelectedTeam: {
        authentication: true,
        helper: function( user ) {
            return Session.getSelectedTeam()
        }
    },
    getSelectedFacility: {
        authentication: true,
        helper: function( user ) {
            return Session.getSelectedFacility()
        }
    },
    getRequests: {
        authentication: true,
        //subscription:???
        helper: function( user, filter, options = {
            expandPMP: false
        } ) {
            var team = user.getSelectedTeam();
            var role = user.getRole();

            if ( !team ) {
                return [];
            }

            var myFacilities = Facilities.find( {
                    "members._id": user._id
                } )
                .fetch();
            var myFacilityIds = _.pluck( myFacilities, '_id' );


            //fragments to use in query
            var isNotDraft = {
                status: {
                    $in: [ Issues.STATUS_NEW, Issues.STATUS_ISSUED, "PMP", "In Progress", "Progress", "Quoting", "Quoted", Issues.STATUS_CLOSED ]
                }
            };
            var isIssued = {
                status: {
                    $in: [ Issues.STATUS_ISSUED, "In Progress", "Progress", "Quoting", "Quoted", Issues.STATUS_CLOSED ]
                }
            };
            var isOpen = {
                status: {
                    $in: [ Issues.STATUS_NEW, "PMP", "In Progress", "Progress", Issues.STATUS_ISSUED ]
                }
            };
            var isNotClosed = {
                status: {
                    $in: [ Issues.STATUS_DRAFT, Issues.STATUS_NEW, "PMP", "In Progress", "Progress", "Quoting", "Quoted", Issues.STATUS_ISSUED ]
                }
            };
            var createdByMe = {
                "owner._id": user._id
            };

            var createdByMyTeam = {
                $and: [ {
                    "team._id": team._id
                }, isNotDraft ]
            };
            var issuedToMyTeam = {
                $and: [ {
                    $or: [ {
                        "supplier._id": team._id
                    }, {
                        "supplier.name": team.name
                    } ]
                }, isIssued ]
            };
            var assignedToMe = {
                $and: [ {
                    "assignee._id": user._id
                }, isIssued ]
            };
            var inMyFacilities = {
                $and: [ {
                    "facility._id": {
                        $in: myFacilityIds
                    }
                }, isNotDraft ]
            };

            var query = [];

            //if staff or tenant restrict to issues created by or assigned to me
            if ( role == "portfolio manager" ) {
                query.push( {
                    $or: [ issuedToMyTeam, createdByMyTeam, createdByMe, assignedToMe ]
                } );
            }
            //if manager can be issued to team, created by team, created by me, or assigned to me
            else if ( role == "manager" ) {
                if ( team.type == "contractor" ) {
                    query.push( {
                        $or: [ issuedToMyTeam, createdByMe, assignedToMe ]
                    } );
                } else if ( team.type == "fm" ) {
                    query.push( {
                        $or: [ inMyFacilities, {
                            $and: [ createdByMe, isNotClosed ]
                        }, {
                            $and: [ assignedToMe, isOpen ]
                        } ]
                    } );
                }
            } else {
                query.push( {
                    $or: [ createdByMe, assignedToMe ]
                } );
            }
            //if filter passed to function then add that to the query
            if ( filter ) {
                query.push( filter );
            }

            var requests = Issues.find( {
                    $and: query
                } )
                .fetch( {
                    sort: {
                        createdAt: 1
                    }
                } );

            if ( options.expandPMP ) {
                query.push( {
                    type: "Preventative"
                } );
                var PMPRequests = Issues.find( {
                        $and: query
                    } )
                    .fetch();
                PMPRequests.map( ( r ) => {
                    if ( r.frequency ) {
                        var date = moment( r.dueDate );
                        var repeats = parseInt( r.frequency.repeats );
                        var period = {};
                        period[ r.frequency.unit ] = parseInt( r.frequency.number );
                        //console.log(period);
                        for ( var i = 0; i &lt; repeats; i++ ) {
                            var copy = Object.assign( {}, r ); //_.omit(r,'_id');
                            copy.dueDate = date.add( period )
                                .toDate();
                            copy = Issues._transform( copy );
                            requests.push( copy );
                        }
                    }
                } )
            }

            return requests;
            //perform and return the query
            return Issues.find( {
                    $and: query
                } )
                .fetch( {
                    sort: {
                        createdAt: 1
                    }
                } );
        }
    }
} )

function createUser( item, password ) {
    if ( Meteor.isServer ) {
        var owner = item.owner || {
            _id: Meteor.user()
                ._id,
            name: Meteor.user()
                .name
        }
        var user = {
            email: item.email,
            name: item.name,
            profile: _.extend( {}, item )
        }
        if ( password ) {
            user.password = password;
        }
        var id = Accounts.createUser( user );
        var user = Users.findOne( id );
        if ( owner ) {
            Users.update( id, {
                $set: {
                    owner: owner
                }
            } );
        }
        return user;
    }
}

Meteor.methods( {
    'User.sendInvite': function( userId ) {
        if ( Meteor.isServer ) {
            Accounts.sendEnrollmentEmail( userId );
        }
    },
} )

Users.helpers( {

    collectionName: 'users',

    login: function( callback ) {
        FMCLogin.loginUser( this, callback )
    },

    sendInvite: function() {
        Meteor.call( 'User.sendInvite', this._id );
    },

    hasRole: function( role ) {
        switch ( role ) {
            case 'dev':
                var email = this.emails[ 0 ].address;
                if ( email == 'mrleokeith@gmail.com' || email == 'mr.richo&amp;gmail.com' ) {
                    return true;
                }
                break;
        }
    },

    tourDone: function( tour ) {
        if ( !tour || !tour.id ) return false;
        return ( Users.findOne( {
            _id: this._id,
            "profile.toursCompleted.id": tour.id
        } ) ) != null;
    },

    resetTours: function() {
        Users.update( this._id, {
            $set: {
                "profile.toursCompleted": []
            }
        } );
    },

    markTourDone: function( tour ) {
        if ( !tour || !tour.id ) return;
        Users.update( this._id, {
            $push: {
                "profile.toursCompleted": {
                    id: tour.id,
                    completedDate: new Date()
                }
            }
        } );
    },

    checkTourComplete: function( tour ) {
        var currStepNum = hopscotch.getCurrStepNum();
        var finalStep = tour.steps.length - 1;
        if ( currStepNum == finalStep ) {
            console.log( 'tour complete' );
            this.markTourDone( tour );
        }
    },

    startTour: function( tour ) {
        var currTour, user;
        currTour = hopscotch.getCurrTour();
        //if there is a tour current running and it is a different one from the tour we want to start
        if ( currTour &amp;&amp; currTour.id != tour.id ) {
            currTour = null;
            hopscotch.endTour();
        }
        if ( !currTour ) {
            user = this;
            if ( !user.tourDone( tour ) ) {
                tour.onNext = function() {
                    user.checkTourComplete( tour );
                }
                hopscotch.startTour( tour, 0 );
            }
        }
    },

    getName: function() {
        return this.profile.name || this.profile.firstName || "Guest";
    },

    getEmail: function() {
        return this.profile.email; //this.emails[0].address;
    },

    getAvailableServices: function() {
        return [];
    },


    getProfile: function() {
        if ( !this.profile._id ) {
            this.profile._id = this._id;
        }
        return this.profile;
    },
    selectTeam: function( team ) {
        if ( team ) {
            Session.set( 'selectedTeam', {
                _id: team._id
            } );
        }
        Session.set( 'selectedFacility', 0 );
    },
    getSelectedTeam: function() {
        var selectedTeamQuery = Session.get( 'selectedTeam' );
        return Teams.findOne( selectedTeamQuery );
    },
    selectFacility: function( facility ) {
        Session.set( 'selectedFacility', {
            _id: facility._id
        } );
    },
    getSelectedFacility: function() {
        return Facilities.findOne( Session.get( 'selectedFacility' ) );
    },
    isLoggedIn: function() {
        return this._id == Meteor.userId();
    },
    isLoggedOut: function() {
        return !User.isLoggedIn();
    }
} );

if ( Meteor.isClient ) {
    //I'd really like to remove all of this from here by binding it to user
    Session.setTeamRole = function( role ) {
        return Session.set( 'selectedTeamRole', role );
    }
    Session.getTeamRole = function() {
        return Session.get( 'selectedTeamRole' );
    }
    Session.getSelectedTeam = function() {
        var selectedTeamQuery = Session.get( 'selectedTeam' );
        if ( selectedTeamQuery ) {
            return Teams.findOne( selectedTeamQuery._id );
        }
    }
    Session.selectTeam = function( team ) {
        if ( team ) {
            Session.set( 'selectedTeam', {
                _id: team._id
            } );
        } else {
            Session.set( 'selectedTeam', 0 );
        }
        Session.set( 'selectedFacility', 0 );
    }
    Session.getSelectedFacility = function() {
        var selectedFacilityQuery = Session.get( 'selectedFacility' );
        if ( selectedFacilityQuery ) {
            return Facilities.findOne( selectedFacilityQuery._id );
        }
    }
    Session.selectFacility = function( f ) {
        if ( f ) {
            Session.set( 'selectedFacility', {
                _id: f._id
            } );
        } else {
            Session.set( 'selectedFacility', 0 );
        }
    }
    Session.getSelectedClient = function() {
        var selectedClientQuery = Session.get( 'selectedClient' );
        if ( selectedClientQuery ) {
            return Teams.findOne( selectedClientQuery._id );
        }
    }
    Session.selectClient = function( c ) {
        if ( f ) {
            Session.set( 'selectedClient', {
                _id: c._id
            } );
        }
    }
}
//*/
{
    import { Teams } from '/modules/models/Teams';
    import { Facilities } from '/modules/models/Facilities';
}
export default Users;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-core_Actions.html">core/Actions</a></li><li><a href="module-core_Authentication.html">core/Authentication</a></li><li><a href="module-core_AutoForm.html">core/AutoForm</a></li><li><a href="module-core_Layouts.html">core/Layouts</a></li><li><a href="module-core_ORM.html">core/ORM</a></li><li><a href="module-features.html">features</a></li><li><a href="module-features_Admin.html">features/Admin</a></li><li><a href="module-features_Compliance.html">features/Compliance</a></li><li><a href="module-features_Reports.html">features/Reports</a></li><li><a href="module-mixins.html">mixins</a></li><li><a href="module-mixins_Areas.html">mixins/Areas</a></li><li><a href="module-mixins_Members.html">mixins/Members</a></li><li><a href="module-mixins_Owners.html">mixins/Owners</a></li><li><a href="module-mixins_Roles.html">mixins/Roles</a></li><li><a href="module-mixins_Services.html">mixins/Services</a></li><li><a href="module-mixins_Thumbs.html">mixins/Thumbs</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_Documents.html">models/Documents</a></li><li><a href="module-models_Facilities.html">models/Facilities</a></li><li><a href="module-models_Files.html">models/Files</a></li><li><a href="module-models_Messages.html">models/Messages</a></li><li><a href="module-models_Notifications.html">models/Notifications</a></li><li><a href="module-models_Requests.html">models/Requests</a></li><li><a href="module-models_Teams.html">models/Teams</a></li><li><a href="module-models_Users.html">models/Users</a></li><li><a href="module-ui.html">ui</a></li><li><a href="module-ui_Calendar.html">ui/Calendar</a></li><li><a href="module-ui_DataTable.html">ui/DataTable</a></li><li><a href="module-ui_MaterialInputs.html">ui/MaterialInputs</a></li><li><a href="module-ui_MaterialMisc.html">ui/MaterialMisc</a></li><li><a href="module-ui_MaterialNavigation.html">ui/MaterialNavigation</a></li><li><a href="module-ui_MaterialViews.html">ui/MaterialViews</a></li><li><a href="module-ui_Modal.html">ui/Modal</a></li><li><a href="module-ui_Stepper.html">ui/Stepper</a></li><li><a href="module-ui_Tabs.html">ui/Tabs</a></li></ul><h3>Classes</h3><ul><li><a href="module-core_Actions.Action.html">Action</a></li><li><a href="module-core_Actions.ActionGroup.html">ActionGroup</a></li><li><a href="module-core_Actions.Route.html">Route</a></li><li><a href="module-core_Actions.RouteGroup.html">RouteGroup</a></li><li><a href="module-core_AutoForm.AutoForm.html">AutoForm</a></li><li><a href="module-core_AutoForm.FormController.html">FormController</a></li><li><a href="module-core_Layouts.BlankLayout.html">BlankLayout</a></li><li><a href="module-core_Layouts.FloatingActionButtonContainer.html">FloatingActionButtonContainer</a></li><li><a href="module-core_Layouts.MainLayout.html">MainLayout</a></li><li><a href="module-core_Layouts.NavigationDrawerContainer.html">NavigationDrawerContainer</a></li><li><a href="module-core_Layouts.PrintLayout.html">PrintLayout</a></li><li><a href="module-core_Layouts.TopNavigationBarContainer.html">TopNavigationBarContainer</a></li><li><a href="module-core_Layouts.WideLayout.html">WideLayout</a></li><li><a href="module-core_ORM.Model.html">Model</a></li><li><a href="module-core_ORM.ValidatedMethod.html">ValidatedMethod</a></li><li><a href="module-models_Facilities.FacilityPanel.html">FacilityPanel</a></li><li><a href="module-models_Users.UserPageProfileContainer.html">UserPageProfileContainer</a></li><li><a href="module-ui_MaterialInputs.DateInput.html">DateInput</a></li><li><a href="module-ui_MaterialInputs.DateTime.html">DateTime</a></li><li><a href="module-ui_MaterialInputs.FileField.html">FileField</a></li><li><a href="module-ui_MaterialInputs.PlainCard.html">PlainCard</a></li><li><a href="module-ui_MaterialInputs.Rating.html">Rating</a></li><li><a href="module-ui_MaterialInputs.Select.html">Select</a></li><li><a href="module-ui_MaterialInputs.Switch.html">Switch</a></li><li><a href="module-ui_MaterialInputs.Text.html">Text</a></li><li><a href="module-ui_MaterialInputs.TextArea.html">TextArea</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Elastic">Elastic</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Sep 21 2016 21:54:02 GMT+1000 (E. Australia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
